#!/usr/bin/python

from __future__ import with_statement
import sys, os
import re
from optparse import OptionParser


pkgConfigPath = os.environ.get("PKG_CONFIG_PATH")
if pkgConfigPath is None:
    pkgConfigPath = ''
pathList = re.split(':', pkgConfigPath)

usage = "usage: %prog [options] package-1 ... package-n"
parser = OptionParser(version="packageDep version @VERSION@", usage=usage)

parser.add_option("-o", "--ouput", dest="filename",
                  help="write graph to FILE", metavar="FILE")

(options, args) = parser.parse_args()

if options.filename is None:
    parser.print_help()

packageList = args
filename = options.filename

requireExpr = re.compile('(\s*Requires:\s+)(.+)')
pkgStdName = re.compile('\w+[\w\d\._-]*');

packageSet = set()
dependencySet = set()

def extractDep(inPkg):

    packageSet.add(inPkg)
    depSet = set()
    
    """Loop over directories in PKG_CONFIG_PATH """
    
    for path in pathList:
        found = False
        filePc = path+"/"+inPkg+".pc"
        
        try:
            with open(filePc) as f:
                for line in f:
                    matchLine = requireExpr.match(line)
                    if matchLine:
                        requireList = re.split(':', matchLine.group(0))
                        depLine = requireList[1]
                        depFullList = re.split(',', depLine)
                        for depFull in depFullList:
                            dep = pkgStdName.search(depFull)
                            if dep:
                                depName = dep.group(0)
                                depSet.add(depName)
                                depString = "\"" + inPkg + "\" -> \"" + depName + "\" [arrowhead = open, style = dashed]"
                                dependencySet.add(depString)

        except IOError, ex:
            None

    for dep in depSet:
        print "extracting ", dep
        extractDep(dep)

for pkg in packageList:
    extractDep(pkg)

#
# Extract data from package and dependency sets
#

try:
    f = open(filename, 'w')
except IOError, ex:
    print "cannot open ", filename

f.write("digraph CD  {\n")
f.write("\tsize = \"12,15\"\n")
f.write("\trankdir = BT\n")
f.write("\tcompound=true\n")
f.write("\n")

for package in packageSet:
    f.write("\t\"" + package + "\" [shape = box]\n")


for dependency in dependencySet:
    f.write("\t" + dependency + "\n");

f.write("}\n")
